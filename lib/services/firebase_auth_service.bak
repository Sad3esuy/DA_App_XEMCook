import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/foundation.dart';
import 'package:google_sign_in/google_sign_in.dart';
import 'dart:typed_data';
import 'package:firebase_storage/firebase_storage.dart';
// Modern approach: use FirebaseAuth providers for all platforms

class FirebaseAuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  // GoogleSignIn instance is no longer required with signInWithProvider

  // Láº¥y user hiá»‡n táº¡i
  User? get currentUser => _auth.currentUser;

  // Stream theo dÃµi tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
  Stream<User?> get authStateChanges => _auth.authStateChanges();

  // ÄÄƒng kÃ½ vá»›i Email & Password
  Future<AuthResult> registerWithEmail({
    required String fullName,
    required String email,
    required String password,
  }) async {
    try {
      // Táº¡o tÃ i khoáº£n Firebase Auth
      final UserCredential userCredential = await _auth.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );

      final User? user = userCredential.user;

      if (user != null) {
        // Cáº­p nháº­t display name
        await user.updateDisplayName(fullName);

        // LÆ°u thÃ´ng tin bá»• sung vÃ o Firestore
        await _firestore.collection('users').doc(user.uid).set({
          'uid': user.uid,
          'fullName': fullName,
          'email': email,
          'createdAt': FieldValue.serverTimestamp(),
          'updatedAt': FieldValue.serverTimestamp(),
        });

        // Gá»­i email xÃ¡c thá»±c (tÃ¹y chá»n)
        // await user.sendEmailVerification();

        return AuthResult(
          success: true,
          message: 'ÄÄƒng kÃ½ thÃ nh cÃ´ng!',
          user: UserData(
            uid: user.uid,
            fullName: fullName,
            email: email,
            providers: user.providerData.map((p) => p.providerId).toList(),
          ),
        );
      }

      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i. Vui lÃ²ng thá»­ láº¡i.',
      );
    } on FirebaseAuthException catch (e) {
      return AuthResult(
        success: false,
        message: _getErrorMessage(e.code),
      );
    } catch (e) {
      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i: ${e.toString()}',
      );
    }
  }

  // ÄÄƒng nháº­p vá»›i Email & Password
  Future<AuthResult> signInWithEmail({
    required String email,
    required String password,
  }) async {
    try {
      final UserCredential userCredential = await _auth.signInWithEmailAndPassword(
        email: email,
        password: password,
      );

      final User? user = userCredential.user;

      if (user != null) {
        // Láº¥y thÃ´ng tin tá»« Firestore
        final DocumentSnapshot userDoc = await _firestore
            .collection('users')
            .doc(user.uid)
            .get();

        final userData = userDoc.data() as Map<String, dynamic>?;

        return AuthResult(
          success: true,
          message: 'ÄÄƒng nháº­p thÃ nh cÃ´ng!',
          user: UserData(
            uid: user.uid,
            fullName: userData?['fullName'] ?? user.displayName ?? 'NgÆ°á»i dÃ¹ng',
            email: user.email ?? email,
            providers: user.providerData.map((p) => p.providerId).toList(),
          ),
        );
      }

      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i. Vui lÃ²ng thá»­ láº¡i.',
      );
    } on FirebaseAuthException catch (e) {
      return AuthResult(
        success: false,
        message: _getErrorMessage(e.code),
      );
    } catch (e) {
      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i: ${e.toString()}',
      );
    }
  }

  // QuÃªn máº­t kháº©u - Gá»­i email reset
  Future<AuthResult> sendPasswordResetEmail(String email) async {
    try {
      await _auth.sendPasswordResetEmail(email: email);

      return AuthResult(
        success: true,
        message: 'Email Ä‘áº·t láº¡i máº­t kháº©u Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n $email.\nVui lÃ²ng kiá»ƒm tra há»™p thÆ° cá»§a báº¡n.',
      );
    } on FirebaseAuthException catch (e) {
      return AuthResult(
        success: false,
        message: _getErrorMessage(e.code),
      );
    } catch (e) {
      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i: ${e.toString()}',
      );
    }
  }

  // Äá»•i máº­t kháº©u (khi Ä‘Ã£ Ä‘Äƒng nháº­p)
  Future<AuthResult> changePassword({
    required String currentPassword,
    required String newPassword,
  }) async {
    try {
      final User? user = _auth.currentUser;
      if (user == null) {
        return AuthResult(
          success: false,
          message: 'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ thá»±c hiá»‡n thao tÃ¡c nÃ y.',
        );
      }

      // XÃ¡c thá»±c láº¡i vá»›i máº­t kháº©u hiá»‡n táº¡i
      final credential = EmailAuthProvider.credential(
        email: user.email!,
        password: currentPassword,
      );

      await user.reauthenticateWithCredential(credential);

      // Äá»•i máº­t kháº©u
      await user.updatePassword(newPassword);

      return AuthResult(
        success: true,
        message: 'Äá»•i máº­t kháº©u thÃ nh cÃ´ng!',
      );
    } on FirebaseAuthException catch (e) {
      return AuthResult(
        success: false,
        message: _getErrorMessage(e.code),
      );
    } catch (e) {
      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i: ${e.toString()}',
      );
    }
  }

  // Láº¥y thÃ´ng tin user hiá»‡n táº¡i
  Future<UserData?> getCurrentUserData() async {
    try {
      final User? user = _auth.currentUser;
      if (user == null) return null;

      final DocumentSnapshot userDoc = await _firestore
          .collection('users')
          .doc(user.uid)
          .get();

      if (!userDoc.exists) return null;

      final userData = userDoc.data() as Map<String, dynamic>;

      return UserData(
        uid: user.uid,
        fullName: userData['fullName'] ?? user.displayName ?? 'NgÆ°á»i dÃ¹ng',
        email: userData['email'] ?? user.email ?? '',
        photoURL: (userData['photoURL'] as String?) ?? user.photoURL,
        providers: user.providerData.map((p) => p.providerId).toList(),
      );
    } catch (e) {
      return null;
    }
  }

  // Kiá»ƒm tra tÃ i khoáº£n hiá»‡n táº¡i cÃ³ Ä‘Äƒng nháº­p báº±ng Google hay khÃ´ng
  bool isGoogleUser() {
    final User? user = _auth.currentUser;
    if (user == null) return false;
    return user.providerData.any((p) => p.providerId == 'google.com');
  }

  // Cáº­p nháº­t profile
  Future<AuthResult> updateProfile({
    String? fullName,
    String? photoURL,
  }) async {
    try {
      final User? user = _auth.currentUser;
      if (user == null) {
        return AuthResult(
          success: false,
          message: 'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ thá»±c hiá»‡n thao tÃ¡c nÃ y.',
        );
      }

      // Cáº­p nháº­t Firebase Auth
      if (fullName != null) {
        await user.updateDisplayName(fullName);
      }
      if (photoURL != null) {
        await user.updatePhotoURL(photoURL);
      }

      // Cáº­p nháº­t Firestore
      final Map<String, dynamic> updates = {
        'updatedAt': FieldValue.serverTimestamp(),
      };
      if (fullName != null) updates['fullName'] = fullName;
      if (photoURL != null) updates['photoURL'] = photoURL;

      await _firestore.collection('users').doc(user.uid).update(updates);

      return AuthResult(
        success: true,
        message: 'Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng!',
      );
    } catch (e) {
      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i: ${e.toString()}',
      );
    }
  }

  // Upload avatar to Firebase Storage and update photoURL
  Future<AuthResult> uploadProfilePhoto(Uint8List data, {String contentType = 'image/jpeg'}) async {
    try {
      final User? user = _auth.currentUser;
      if (user == null) {
        return AuthResult(
          success: false,
          message: 'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ thá»±c hiá»‡n thao tÃ¡c nÃ y.',
        );
      }

      final storage = FirebaseStorage.instance;
      final fileName = 'profile_${DateTime.now().millisecondsSinceEpoch}.jpg';
      final ref = storage.ref().child('users/${user.uid}/$fileName');
      final uploadTask = ref.putData(
        data,
        SettableMetadata(
          contentType: contentType,
          cacheControl: 'public, max-age=3600',
        ),
      );
      final snapshot = await uploadTask.whenComplete(() {});
      final url = await snapshot.ref.getDownloadURL();

      // Update both Auth and Firestore
      await user.updatePhotoURL(url);
      await _firestore.collection('users').doc(user.uid).update({
        'photoURL': url,
        'updatedAt': FieldValue.serverTimestamp(),
      });

      return AuthResult(success: true, message: 'Cáº­p nháº­t áº£nh Ä‘áº¡i diá»‡n thÃ nh cÃ´ng!');
    } on FirebaseException catch (e) {
      return AuthResult(success: false, message: 'Lá»—i lÆ°u áº£nh: ${e.message ?? e.code}');
    } catch (e) {
      return AuthResult(success: false, message: 'ÄÃ£ xáº£y ra lá»—i: ${e.toString()}');
    }
  }

  // ÄÄƒng nháº­p vá»›i Google (native on mobile via google_sign_in, popup on web)
  Future<AuthResult> signInWithGoogle() async {
    try {
      UserCredential? userCredential;
      if (kIsWeb) {
        final googleProvider = GoogleAuthProvider()
          ..addScope('email')
          ..addScope('profile')
          ..setCustomParameters({'prompt': 'select_account'});
        try {
          userCredential = await _auth.signInWithPopup(googleProvider);
        } on FirebaseAuthException catch (e) {
          if (e.code == 'operation-not-supported-in-this-environment' ||
              e.code == 'web-storage-unsupported' ||
              e.code == 'popup-blocked' ||
              e.code == 'popup-closed-by-user') {
            await _auth.signInWithRedirect(googleProvider);
            return AuthResult(success: false, message: 'Äang chuyá»ƒn hÆ°á»›ng Ä‘á»ƒ Ä‘Äƒng nháº­p Google...');
          }
          rethrow;
        }
      } else {
        // Android/iOS: native google_sign_in flow
        final GoogleSignIn googleSignIn = GoogleSignIn(scopes: ['email', 'profile']);
        final GoogleSignInAccount? account = await googleSignIn.signIn();
        if (account == null) {
          return AuthResult(success: false, message: 'ÄÄƒng nháº­p Google Ä‘Ã£ há»§y.');
        }
        final GoogleSignInAuthentication auth = await account.authentication;
        final credential = GoogleAuthProvider.credential(
          accessToken: auth.accessToken,
          idToken: auth.idToken,
        );
        userCredential = await _auth.signInWithCredential(credential);
      }

      final User? user = userCredential.user;

      if (user != null) {
        // Kiá»ƒm tra xem user Ä‘Ã£ tá»“n táº¡i trong Firestore chÆ°a
        final userDoc = await _firestore.collection('users').doc(user.uid).get();

        if (!userDoc.exists) {
          // User má»›i - Táº¡o document trong Firestore
          await _firestore.collection('users').doc(user.uid).set({
            'uid': user.uid,
            'fullName': user.displayName ?? 'NgÆ°á»i dÃ¹ng Google',
            'email': user.email ?? '',
            'photoURL': user.photoURL,
            'provider': 'google',
            'createdAt': FieldValue.serverTimestamp(),
            'updatedAt': FieldValue.serverTimestamp(),
          });
        } else {
          // User cÅ© - Cáº­p nháº­t thÃ´ng tin má»›i nháº¥t
          await _firestore.collection('users').doc(user.uid).update({
            'updatedAt': FieldValue.serverTimestamp(),
            'photoURL': user.photoURL,
          });
        }

        return AuthResult(
          success: true,
          message: 'ÄÄƒng nháº­p thÃ nh cÃ´ng!',
          user: UserData(
            uid: user.uid,
            fullName: user.displayName ?? 'NgÆ°á»i dÃ¹ng Google',
            email: user.email ?? '',
            photoURL: user.photoURL,
            providers: user.providerData.map((p) => p.providerId).toList(),
          ),
        );
      }

      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i. Vui lÃ²ng thá»­ láº¡i.',
      );
    } on FirebaseAuthException catch (e) {
      return AuthResult(
        success: false,
        message: _getErrorMessage(e.code),
      );
    } catch (e) {
      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i: ${e.toString()}',
      );
    }
  }

  

  // ÄÄƒng xuáº¥t
  Future<void> signOut() async {
    await _auth.signOut();
  }

  // XÃ³a tÃ i khoáº£n: há»— trá»£ cáº£ email/password vÃ  Google
  Future<AuthResult> deleteAccount(String password) async {
    try {
      final User? user = _auth.currentUser;
      if (user == null) {
        return AuthResult(
          success: false,
          message: 'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ thá»±c hiá»‡n thao tÃ¡c nÃ y.',
        );
      }

      // Láº¥y provider hiá»‡n táº¡i
      final List<String> providers =
          user.providerData.map((p) => p.providerId).toList();

      if (providers.contains('password')) {
        if ((user.email ?? '').isEmpty) {
          return AuthResult(success: false, message: 'TÃ i khoáº£n khÃ´ng cÃ³ email.');
        }
        if (password.isEmpty) {
          return AuthResult(success: false, message: 'Vui lÃ²ng nháº­p máº­t kháº©u.');
        }
        final credential = EmailAuthProvider.credential(
          email: user.email!,
          password: password,
        );
        await user.reauthenticateWithCredential(credential);
      } else if (providers.contains('google.com')) {
        if (kIsWeb) {
          final googleProvider = GoogleAuthProvider()
            ..addScope('email')
            ..setCustomParameters({'prompt': 'select_account'});
          await user.reauthenticateWithPopup(googleProvider);
        } else {
          final GoogleSignIn googleSignIn =
              GoogleSignIn(scopes: ['email', 'profile']);
          final GoogleSignInAccount? account = await googleSignIn.signIn();
          if (account == null) {
            return AuthResult(
                success: false, message: 'ÄÃ£ huá»· xÃ¡c thá»±c Google.');
          }
          final GoogleSignInAuthentication auth = await account.authentication;
          final credential = GoogleAuthProvider.credential(
            accessToken: auth.accessToken,
            idToken: auth.idToken,
          );
          await user.reauthenticateWithCredential(credential);
        }
      } else {
        return AuthResult(
          success: false,
          message:
              'ChÆ°a há»— trá»£ xoÃ¡ cho phÆ°Æ¡ng thá»©c Ä‘Äƒng nháº­p nÃ y. Vui lÃ²ng liÃªn há»‡ há»— trá»£.',
        );
      }

      // XÃ³a dá»¯ liá»‡u Firestore
      await _firestore.collection('users').doc(user.uid).delete();

      // Thá»­ xÃ³a thÆ° má»¥c áº£nh ngÆ°á»i dÃ¹ng trong Storage (náº¿u cÃ³)
      try {
        final storage = FirebaseStorage.instance;
        final folderRef = storage.ref().child('users/${user.uid}');
        final list = await folderRef.listAll();
        for (final item in list.items) {
          await item.delete();
        }
      } catch (_) {}

      // XÃ³a tÃ i khoáº£n Auth
      await user.delete();

      return AuthResult(
        success: true,
        message: 'TÃ i khoáº£n Ä‘Ã£ Ä‘Æ°á»£c xÃ³a thÃ nh cÃ´ng.',
      );
    } on FirebaseAuthException catch (e) {
      return AuthResult(
        success: false,
        message: _getErrorMessage(e.code),
      );
    } catch (e) {
      return AuthResult(
        success: false,
        message: 'ÄÃ£ xáº£y ra lá»—i: ${e.toString()}',
      );
    }
  }

  // Chuyá»ƒn Ä‘á»•i mÃ£ lá»—i Firebase thÃ nh thÃ´ng bÃ¡o tiáº¿ng Viá»‡t
  String _getErrorMessage(String code) {
    switch (code) {
      case 'email-already-in-use':
        return 'Email nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi tÃ i khoáº£n khÃ¡c.';
      case 'invalid-email':
        return 'Email khÃ´ng há»£p lá»‡.';
      case 'operation-not-allowed':
        return 'PhÆ°Æ¡ng thá»©c Ä‘Äƒng nháº­p nÃ y chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t.';
      case 'weak-password':
        return 'Máº­t kháº©u quÃ¡ yáº¿u. Vui lÃ²ng chá»n máº­t kháº©u máº¡nh hÆ¡n.';
      case 'user-disabled':
        return 'TÃ i khoáº£n nÃ y Ä‘Ã£ bá»‹ vÃ´ hiá»‡u hÃ³a.';
      case 'user-not-found':
        return 'KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n vá»›i email nÃ y.';
      case 'wrong-password':
        return 'Máº­t kháº©u khÃ´ng chÃ­nh xÃ¡c.';
      case 'invalid-credential':
        return 'ThÃ´ng tin Ä‘Äƒng nháº­p khÃ´ng há»£p lá»‡.';
      case 'account-exists-with-different-credential':
        return 'TÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i vá»›i phÆ°Æ¡ng thá»©c Ä‘Äƒng nháº­p khÃ¡c.';
      case 'requires-recent-login':
        return 'Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i Ä‘á»ƒ thá»±c hiá»‡n thao tÃ¡c nÃ y.';
      case 'network-request-failed':
        return 'Lá»—i káº¿t ná»‘i máº¡ng. Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i cá»§a báº¡n.';
      case 'too-many-requests':
        return 'QuÃ¡ nhiá»u yÃªu cáº§u. Vui lÃ²ng thá»­ láº¡i sau.';
      default:
        return 'ÄÃ£ xáº£y ra lá»—i. Vui lÃ²ng thá»­ láº¡i. ($code)';
    }
  }
}

// Models
class AuthResult {
  final bool success;
  final String message;
  final UserData? user;

  AuthResult({
    required this.success,
    required this.message,
    this.user,
  });
}

class UserData {
  final String uid;
  final String fullName;
  final String email;
  final String? photoURL;
  final List<String> providers;

  UserData({
    required this.uid,
    required this.fullName,
    required this.email,
    this.photoURL,
    this.providers = const [],
  });
}
